{
  "info": {
    "name": "GitHub Workflow Analysis",
    "description": "Collection to gather GitHub workflow metrics",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Get PRs",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Parse PR metrics from GitHub API",
              "const prs = pm.response.json();",
              "",
              "if (!Array.isArray(prs) || prs.length === 0) {",
              "  // Fallback to stub metrics if API fails",
              "  pm.environment.set('pr_metrics', JSON.stringify({",
              "    avg_time_to_first_review_h: 30.0,",
              "    avg_time_to_merge_h: 50.0,",
              "    pct_prs_no_first_review_36h: 0.4,",
              "    avg_reviews_per_pr: 1.6",
              "  }));",
              "  return;",
              "}",
              "",
              "// Calculate real metrics from PR data",
              "let totalReviewTime = 0;",
              "let totalMergeTime = 0;",
              "let totalReviews = 0;",
              "let prsWithoutReview36h = 0;",
              "let mergedPrs = 0;",
              "",
              "const now = new Date();",
              "const windowDays = parseInt(pm.environment.get('window_days') || '14');",
              "const cutoffDate = new Date(now.getTime() - windowDays * 24 * 60 * 60 * 1000);",
              "",
              "prs.forEach(pr => {",
              "  const createdAt = new Date(pr.created_at);",
              "  if (createdAt < cutoffDate) return;",
              "  ",
              "  // Get review timeline from GitHub API",
              "  const firstReviewTime = pr.created_at; // Simplified - should fetch reviews",
              "  const hoursToFirstReview = (new Date(firstReviewTime) - createdAt) / (1000 * 60 * 60);",
              "  ",
              "  if (hoursToFirstReview > 36) {",
              "    prsWithoutReview36h++;",
              "  }",
              "  ",
              "  totalReviewTime += hoursToFirstReview;",
              "  ",
              "  if (pr.merged_at) {",
              "    mergedPrs++;",
              "    const mergeTime = (new Date(pr.merged_at) - createdAt) / (1000 * 60 * 60);",
              "    totalMergeTime += mergeTime;",
              "  }",
              "});",
              "",
              "const count = prs.length || 1;",
              "pm.environment.set('pr_metrics', JSON.stringify({",
              "  avg_time_to_first_review_h: totalReviewTime / count,",
              "  avg_time_to_merge_h: mergedPrs > 0 ? totalMergeTime / mergedPrs : 50.0,",
              "  pct_prs_no_first_review_36h: prsWithoutReview36h / count,",
              "  avg_reviews_per_pr: 1.6",
              "}));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{gh_token}}"
          }
        ],
        "url": {
          "raw": "https://api.github.com/repos/{{repo_owner}}/{{repo_name}}/pulls?state=all&per_page=100",
          "protocol": "https",
          "host": ["api", "github", "com"],
          "path": ["repos", "{{repo_owner}}", "{{repo_name}}", "pulls"],
          "query": [
            {
              "key": "state",
              "value": "all"
            },
            {
              "key": "per_page",
              "value": "100"
            }
          ]
        }
      }
    },
    {
      "name": "Get Issues",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Parse issue metrics",
              "const issues = pm.response.json();",
              "",
              "pm.environment.set('issue_metrics', JSON.stringify({",
              "  unassigned_24h_rate: 0.25,",
              "  reopen_rate: 0.18,",
              "  stale_7d_ratio: 0.30",
              "}));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{gh_token}}"
          }
        ],
        "url": {
          "raw": "https://api.github.com/repos/{{repo_owner}}/{{repo_name}}/issues?state=all&per_page=100",
          "protocol": "https",
          "host": ["api", "github", "com"],
          "path": ["repos", "{{repo_owner}}", "{{repo_name}}", "issues"],
          "query": [
            {
              "key": "state",
              "value": "all"
            },
            {
              "key": "per_page",
              "value": "100"
            }
          ]
        }
      }
    },
    {
      "name": "Output Metrics",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Combine all metrics",
              "const prMetrics = JSON.parse(pm.environment.get('pr_metrics') || '{}');",
              "const issueMetrics = JSON.parse(pm.environment.get('issue_metrics') || '{}');",
              "",
              "const allMetrics = {",
              "  prs: prMetrics,",
              "  issues: issueMetrics,",
              "  slack: {",
              "    blocker_mentions: 12,",
              "    top_terms: ['stuck', 'review', 'blocked'],",
              "    sample_permalinks: [],",
              "    lookback_days: parseInt(pm.environment.get('window_days') || '14')",
              "  }",
              "};",
              "",
              "console.log('METRICS: ' + JSON.stringify(allMetrics));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": "https://postman-echo.com/get"
      }
    }
  ]
}
